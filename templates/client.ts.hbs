import {
  PlayerName,
  {{userState}},
  {{#each methods}}
  {{#if (ne @key ../initialize)}}
  {{makeRequestName @key}},
  {{/if}}
  {{/each}}
} from "./types";

export type StateId = string;

export class LsotClient {
  private callbacks: Record<string, (error?: string) => void> = {};

  private constructor(private socket: WebSocket) {}

  public static async registerUser(username: PlayerName): Promise<string> {
    const res = await fetch("/register", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ playerName: username }),
    });
    const { token } = await res.json();
    return token;
  }

  public static async createState(token: string): Promise<StateId> {
    const res = await fetch("/new", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token,
      },
    });
    const { stateId } = await res.json();
    return stateId;
  }

  public static async connect(
    token: string,
    stateId: StateId,
    onStateChange: (state: {{userState}}) => void
  ): Promise<LsotClient> {
    const socket = new WebSocket(`ws://${location.host}/${stateId}`);
    const client = new LsotClient(socket);
    socket.onopen = () => socket.send(token);
    socket.onmessage = ({ data }) => {
      const message = JSON.parse(data);
      if (message.type === "response") {
        client.callbacks[message.msgId](message.error);
        delete client.callbacks[message.msdId];
      } else if (message.type === "state") {
        onStateChange(message.state);
      } else {
        console.error("Unknown message type: " + message.type);
      }
    };
    return client;
  }

  {{#each methods}}
  {{#if (ne @key ../initialize)}}
  public {{@key}}(request: {{makeRequestName @key}}, cb: (error?: string) => void): void {
    const msgId = Math.random().toString(36).substring(2);
    this.callbacks[msgId] = cb;
    this.socket.send(JSON.stringify({ method: "{{@key}}", msgId, args: request }));
  }

  {{/if}}
  {{/each}}
  public disconnect(): void {
    this.socket.close();
  }
}
