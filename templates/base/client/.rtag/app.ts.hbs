import ReactDOM from "react-dom";
import { Forms } from "./Forms";
import { State } from "./State";
import { RtagClient } from "./client";
import { {{userState}} as UserState } from "./types";

const client = new RtagClient(import.meta.env.VITE_APP_ID);
if (sessionStorage.getItem("token") === null) {
  sessionStorage.setItem("token", await client.loginAnonymous());
}
const token = sessionStorage.getItem("token")!;
const connection = await getClient(token, (state) => ReactDOM.render(State(state), document.getElementById("state")));
ReactDOM.render(Forms(connection), document.getElementById("forms"));

async function getClient(token: string, onStateChange: (state: UserState) => void) {
  if (location.pathname.length > 1) {
    const connection = await client.connectExisting(token, location.pathname.split("/").pop()!, onStateChange);
    return connection;
  } else {
    const connection = await client.connectNew(token, {}, onStateChange);
    history.pushState({}, "", `/${connection.stateId}`);
    return connection;
  }
}
