# Deploy

After your application is working as desired locally, you may want to deploy it on the internet.

## Build

First, you must build your project by running `hathora build`. This will create a `dist` inside your `server` directory and also inside each of your client subdirectories.

The directory structure will look something like this:

```
. # project root
├─ client
│  ├─ prototype-ui
│  │  ├─ package.json
│  │  └─ dist
│  └─ web
│     ├─ package.json
│     └─ dist
└─ server
   └─ dist
```

## Client

The `client/<app>` directory is a self contained frontend application and can be deployed to any cdn like [netlify](https://www.netlify.com/), [vercel](vercel.com), or [surge](https://surge.sh/).

For example, you can deploy your application's Prototype UI to surge by running the following command from your project root:

```sh
surge client/prototype-ui/dist my-app.surge.sh
```

## Server

The `server/dist` directory is a self contains backend application that can be deployed to any cloud server or application hosting environment.

For typescript backends, the only file inside the `server/dist` directory is `index.mjs`. The two requirements for running the backend are:

- node.js must be installed
- the `DATA_DIR` environment variable must be set to the path where Hathora should write its data files
- the `COORDINATOR_HOST` environment variable must be set to the URL of the Coordinator being used

Example command to start the backend:

```sh
COORDINATOR_HOST=coordinator.hathora.dev DATA_DIR=./data node index.mjs
```

> For running in production, it may be preferable to use a process manager like [pm2](https://pm2.keymetrics.io/).

## Hathora Cloud

In July 2022, we released the beta version of Hathora Cloud. Currently, games built using the Hathora Framework can be deployed to Hathora Cloud in a few easy steps:

1. Request developer access to Hathora Cloud: https://tinyurl.com/5akptu3z
2. Once our team confirms access, run ```hathora cloud login```
3. Select `y` when prompted with the message below

> Open browser for login? You should see the following code: XXXX-XXXX. › (Y/n)

4. Click confirm to complete the login process and close the browser tab. You will see a green message on terminal once login is successful

> Successfully logged in! Saved credentials to /.../.config/hathora/token

5. Navigate to the project root for your game and confirm there is a Dockerfile (this file is automatically generated when you run `hathora init`)

```
. # project root
├─ client
│  ├─ prototype-ui
│  └─ web
└─ Dockerfile
└─ server
```

6. Now we're ready to deploy your game globally! To access all the cloud functions you can run ```hathora cloud --help```

```sh
hathora cloud

Interact with Hathora Cloud

Commands:
  hathora cloud deploy   Deploys application to Hathora Cloud

  hathora cloud destroy  Destroy a Hathora Cloud application
  hathora cloud info     Get details about a Hathora Cloud application

  hathora cloud list     List Hathora Cloud applications
  hathora cloud login    Login to Hathora Cloud
  hathora cloud logs     Get logs from a Hathora Cloud application

Options:
  --help     Show help                               [boolean]
  --version  Show version number                     [boolean]
```

7. Run `hathora cloud deploy --appName yourAppName` to deploy your game globally. If this is your first time deploying the game, you can name your app whatever you'd like. It will take a few minutes for your app to be deployed and you can watch the logs for progress.
8. To connect local client to the deployed servers, first get the app_secret using `hathora cloud list`. Run your frontend locally as follows

```
APP_SECRET=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX hathora dev --only client
```

10. To destory your application run `hathora cloud destroy --appName yourAppName`


Self-hosting will remain an option for those that want more control.

## Continuous Delivery

Once you have manual deploys working, you may want to set up Continuous Integration to automate the deploy process. We will walk through an example for setting up CI/CD using Github Actions, but the general principles apply to other CI systems as well.

In your Github Repo, select the actions tab and create a custom `.yml` file, for example `deploy.yml`. Replace the auto-generated code with the following:

```
name: Deploy
on:
  push:
    branches:
      - main 

jobs:
  server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install -g hathora
      - run: hathora cloud deploy --appName XXXXXXXXX --token ${{ secrets.HATHORA_TOKEN }}
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm install hathora -g
      - run: APP_SECRET=${{ secrets.HATHORA_APP_SECRET }} hathora build --only client
      - run: echo '/* /index.html 200' > client/web/dist/_redirects;
      - run: |
          npx netlify deploy --prod \
          --site '${{ secrets.NETLIFY_SITE_ID }}' \
          --auth '${{ secrets.NETLIFY_AUTH_TOKEN }}' \
          --dir=client/web/dist;
```

Customize the `name`, `branches`, and `appName` for your app.

> If you're using Personal Access Tokens to push up your code to Github, make sure in *Profile Settings --> Developer Access --> Personal access tokens* that `workflow` access is enabled for your token. 

Next, copy the Hathora token from `~/.config/hathora/token`

> Note you must have already run `hathora cloud login` for the token to be present.

> WARNING: if using `cat` to get the token from the terminal, don't include the **%** character at the end

Save the secret on Github by going to *Repo Settings --> Secrets --> Actions* and creating a `New Repository Secret`. Name the secret `HATHORA_TOKEN` to match `.yml` file above. Paste in the copied value in the `Secret` field.

In this example, the frontend is hosted on Netlify so you will need to get `NETLIFY_SITE_ID` and `NETLIFY_AUTH_TOKEN` from them directly. 

Push a change to the branch specified in the `.yml` file. Once you push your changes, go to `Github Actions` tab to see your deployment logs. 
